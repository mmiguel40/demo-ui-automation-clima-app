name: Ejecución Manual de Pruebas

on:
  workflow_dispatch:
    inputs:
      tags:
        description: "Tags de Cucumber a ejecutar (opcional, ej: @validCredentials)"
        required: false
        default: ""

jobs:
  test_and_report:
    name: Ejecutar Pruebas y Enviar Reporte
    runs-on: ubuntu-latest

    steps:
      - name: Checkout del Código
        uses: actions/checkout@v4

      - name: Configurar JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: "maven"

      - name: Ejecutar Pruebas con Maven
        run: |
          if [ -n "${{ github.event.inputs.tags }}" ]; then
            echo "Ejecutando tags: ${{ github.event.inputs.tags }}"
            mvn clean test -Dcucumber.filter.tags="${{ github.event.inputs.tags }}" -Dheadless=true 2>&1 | tee maven.log
          else
            echo "Ejecutando todas las pruebas"
            mvn clean test -Dheadless=true 2>&1 | tee maven.log
          fi
        continue-on-error: true # Permitir continuar para enviar el reporte aunque fallen los tests

      - name: Extraer Resumen de Pruebas
        if: always()
        run: |
          # Extraer la última línea que contiene "Tests run:"
          SUMMARY=$(grep "Tests run:" maven.log | tail -1)
          if [ -z "$SUMMARY" ]; then SUMMARY="No se pudo obtener el resumen."; fi
          echo "TEST_SUMMARY=$SUMMARY" >> $GITHUB_ENV
          echo "Resumen extraído: $SUMMARY"

      - name: Verificar Existencia del Reporte
        id: check_report
        run: |
          if [ -f "target/extent-reports/SparkReport.html" ]; then
            echo "report_exists=true" >> $GITHUB_OUTPUT
            echo "Reporte HTML encontrado."
          else
            echo "report_exists=false" >> $GITHUB_OUTPUT
            echo "::warning::Reporte HTML no encontrado."
          fi

      - name: Subir Reportes como Artefacto
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: extent-reports
          path: target/extent-reports/
          retention-days: 30

      - name: Notificar a Microsoft Teams
        if: always()
        run: |
          curl -H "Content-Type: application/json" -d '{
            "@type": "MessageCard",
            "@context": "http://schema.org/extensions",
            "themeColor": "0076D7",
            "summary": "Reporte de Pruebas Automatizadas",
            "sections": [{
              "activityTitle": "Ejecución de Pruebas Finalizada",
              "activitySubtitle": "${{ github.repository }}",
              "facts": [
                { "name": "Estado", "value": "${{ job.status }}" },
                { "name": "Resumen", "value": "${{ env.TEST_SUMMARY }}" },
                { "name": "Trigger", "value": "${{ github.event_name }}" },
                { "name": "Usuario", "value": "${{ github.actor }}" }
              ],
              "markdown": true
            }],
            "potentialAction": [{
              "@type": "OpenUri",
              "name": "Ver Reporte y Artefactos",
              "targets": [{ "os": "default", "uri": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" }]
            }]
          }' "${{ secrets.TEAMS_WEBHOOK_URL }}"

      - name: Enviar Reporte por Correo
        uses: dawidd6/action-send-mail@v3
        if: steps.check_report.outputs.report_exists == 'true'
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: Reporte de Pruebas Automatizadas - ${{ github.repository }}
          to: ${{ secrets.MAIL_TO }}
          from: GitHub Actions <${{ secrets.MAIL_USERNAME }}>
          body: |
            Hola,

            La ejecución manual de pruebas ha finalizado.

            Estado del Workflow: ${{ job.status }}
            Repositorio: ${{ github.repository }}
            Ejecutado por: ${{ github.actor }}

            Se adjunta el reporte HTML con los resultados detallados.

            Saludos,
            Tu Bot de Automatización
          attachments: target/extent-reports/SparkReport.html
