name: Ejecución Manual de Pruebas

on:
    workflow_dispatch:
        inputs:
            tags:
                description: "Tags de Cucumber a ejecutar (opcional, ej: @validCredentials)"
                required: false
                default: ""

jobs:
    test_and_report:
        name: Ejecutar Pruebas y Enviar Reporte
        runs-on: ubuntu-latest

        steps:
            - name: Checkout del Código
              uses: actions/checkout@v4

            - name: Configurar JDK 17
              uses: actions/setup-java@v4
              with:
                  java-version: "17"
                  distribution: "temurin"
                  cache: "maven"

            - name: Ejecutar Pruebas con Maven
              run: |
                  if [ -n "${{ github.event.inputs.tags }}" ]; then
                    echo "Ejecutando tags: ${{ github.event.inputs.tags }}"
                    mvn clean test -Dcucumber.filter.tags="${{ github.event.inputs.tags }}"
                  else
                    echo "Ejecutando todas las pruebas"
                    mvn clean test
                  fi
              continue-on-error: true # Permitir continuar para enviar el reporte aunque fallen los tests

            - name: Verificar Existencia del Reporte
              id: check_report
              run: |
                  if [ -f "target/extent-reports/PdfReport.pdf" ]; then
                    echo "report_exists=true" >> $GITHUB_OUTPUT
                    echo "Reporte PDF encontrado."
                  else
                    echo "report_exists=false" >> $GITHUB_OUTPUT
                    echo "::warning::Reporte PDF no encontrado. Verifica la configuración de ExtentReports."
                  fi

            - name: Subir Reportes como Artefacto
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: extent-reports
                  path: target/extent-reports/
                  retention-days: 30

            - name: Enviar Reporte por Correo
              uses: dawidd6/action-send-mail@v3
              if: steps.check_report.outputs.report_exists == 'true'
              with:
                  server_address: smtp.gmail.com
                  server_port: 465
                  secure: true
                  username: ${{ secrets.MAIL_USERNAME }}
                  password: ${{ secrets.MAIL_PASSWORD }}
                  subject: Reporte de Pruebas Automatizadas - ${{ github.repository }}
                  to: ${{ secrets.MAIL_TO }}
                  from: GitHub Actions <${{ secrets.MAIL_USERNAME }}>
                  body: |
                      Hola,

                      La ejecución manual de pruebas ha finalizado.

                      Estado del Workflow: ${{ job.status }}
                      Repositorio: ${{ github.repository }}
                      Ejecutado por: ${{ github.actor }}

                      Se adjunta el reporte PDF con los resultados detallados.

                      Saludos,
                      Tu Bot de Automatización
                  attachments: target/extent-reports/PdfReport.pdf
