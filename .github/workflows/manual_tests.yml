name: EjecuciÃ³n Manual de Pruebas

on:
  workflow_dispatch:
    inputs:
      tags:
        description: "Tags de Cucumber a ejecutar (opcional, ej: @validCredentials)"
        required: false
        default: ""
      notify_emails:
        description: "Correos a notificar (separados por coma, ej: user@org.com, jefe@org.com)"
        required: false
        default: ""

jobs:
  test_and_report:
    name: Ejecutar Pruebas y Enviar Reporte
    runs-on: ubuntu-latest

    steps:
      - name: Checkout del CÃ³digo
        uses: actions/checkout@v4

      - name: Configurar JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: "maven"

      - name: Ejecutar Pruebas con Maven
        run: |
          if [ -n "${{ github.event.inputs.tags }}" ]; then
            echo "Ejecutando tags: ${{ github.event.inputs.tags }}"
            mvn clean test -Dcucumber.filter.tags="${{ github.event.inputs.tags }}" -Dheadless=true 2>&1 | tee maven.log
          else
            echo "Ejecutando todas las pruebas"
            mvn clean test -Dheadless=true 2>&1 | tee maven.log
          fi
        continue-on-error: true # Permitir continuar para enviar el reporte aunque fallen los tests

      - name: Extraer Resumen de Pruebas
        if: always()
        run: |
          # Extraer la Ãºltima lÃ­nea que contiene "Tests run:"
          SUMMARY=$(grep "Tests run:" maven.log | tail -1)
          if [ -z "$SUMMARY" ]; then SUMMARY="No se pudo obtener el resumen."; fi
          echo "TEST_SUMMARY=$SUMMARY" >> $GITHUB_ENV
          echo "Resumen extraÃ­do: $SUMMARY"

      - name: Verificar Existencia del Reporte
        id: check_report
        run: |
          if [ -f "target/extent-reports/SparkReport.html" ]; then
            echo "report_exists=true" >> $GITHUB_OUTPUT
            echo "Reporte HTML encontrado."
          else
            echo "report_exists=false" >> $GITHUB_OUTPUT
            echo "::warning::Reporte HTML no encontrado."
          fi

      - name: Subir Reportes como Artefacto
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: extent-reports
          path: target/extent-reports/
          retention-days: 30

      - name: Notificar a Microsoft Teams (Adaptive Card)
        if: always()
        run: |
          # 1. Definir estado y color
          if [ "${{ job.status }}" == "success" ]; then
            STATUS_COLOR="Good"
            STATUS_EMOJI="âœ…"
          else
            STATUS_COLOR="Attention"
            STATUS_EMOJI="âŒ"
          fi

          # 2. Procesar lista de correos para menciones dinÃ¡micas
          # LÃ³gica: Append (Default List from SEGRETS + Input List)
          INPUT_EMAILS="${{ github.event.inputs.notify_emails }}"
          DEFAULT_EMAILS="${{ secrets.MAIL_TO }}"

          # Concatenar listas (asegurando coma si ambas existen)
          if [ -n "$INPUT_EMAILS" ]; then
             if [ -n "$DEFAULT_EMAILS" ]; then
                EMAILS="$DEFAULT_EMAILS, $INPUT_EMAILS"
             else
                EMAILS="$INPUT_EMAILS"
             fi
          else
             EMAILS="$DEFAULT_EMAILS"
          fi

          MENTION_TEXT=""
          MENTION_ENTITIES="[]"

          if [ -n "$EMAILS" ]; then
            # Convertir string separado por comas a array JSON
            # Ejemplo: "a@b.com, c@d.com" -> ["a@b.com", "c@d.com"]
            # Iterar y construir texto y entidades
            
            # Limpiar espacios extra y separar por coma
            IFS=',' read -ra ADDR <<< "$EMAILS"
            
            ENTITIES_JSON="[]"
            
            for email in "${ADDR[@]}"; do
              # Trim whitespace
              email=$(echo "$email" | xargs)
              
              if [ -n "$email" ]; then
                # Agregar tag al texto visual
                MENTION_TEXT="$MENTION_TEXT <at>$email</at>"
                
                # Crear objeto entidad para este usuario
                ENTITY_OBJ=$(jq -n \
                  --arg email "$email" \
                  '{type: "mention", text: ("<at>" + $email + "</at>"), mentioned: {id: $email, name: $email}}')
                
                # Agregar al array de entidades
                ENTITIES_JSON=$(echo "$ENTITIES_JSON" | jq --argjson entity "$ENTITY_OBJ" '. + [$entity]')
              fi
            done
            
            MENTION_ENTITIES="$ENTITIES_JSON"
          fi

          # 3. Construir el JSON Completo usando jq para mÃ¡xima seguridad
          # Base del payload
          PAYLOAD=$(jq -n \
            --arg status "$STATUS_EMOJI Reporte de AutomatizaciÃ³n" \
            --arg jobStatus "Estado: ${{ job.status }}" \
            --arg statusColor "$STATUS_COLOR" \
            --arg summary "${{ env.TEST_SUMMARY }}" \
            --arg trigger "${{ github.event_name }}" \
            --arg user "${{ github.actor }}" \
            --arg runUrl "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            --arg mentionText "$MENTION_TEXT" \
            --argjson mentionEntities "$MENTION_ENTITIES" \
            '{
              type: "message",
              attachments: [
                {
                  contentType: "application/vnd.microsoft.card.adaptive",
                  content: {
                    "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                    type: "AdaptiveCard",
                    version: "1.2",
                    msteams: { width: "Full", entities: $mentionEntities },
                    body: [
                      {
                        type: "TextBlock",
                        text: $status,
                        weight: "Bolder",
                        size: "Large"
                      },
                      {
                        type: "Container",
                        style: "emphasis",
                        items: [
                          {
                            type: "TextBlock",
                            text: $jobStatus,
                            weight: "Bolder",
                            color: $statusColor,
                            size: "Medium"
                          },
                          {
                            type: "TextBlock",
                            text: $summary,
                            wrap: true
                          }
                        ]
                      },
                      {
                        type: "FactSet",
                        facts: [
                          { title: "Trigger", value: $trigger },
                          { title: "Usuario", value: $user }
                        ]
                      },
                      {
                        type: "TextBlock",
                        text: ("ðŸ“¢ Notificando a: " + $mentionText),
                        size: "Small",
                        isSubtle: true,
                        wrap: true,
                        isVisible: ($mentionText != "")
                      }
                    ],
                    actions: [
                      {
                        type: "Action.OpenUrl",
                        title: "ðŸ”— Ver Reporte HTML",
                        url: $runUrl
                      }
                    ]
                  }
                }
              ]
            }')

          # 4. Enviar
          echo "Enviando payload a Teams..."
          curl -H "Content-Type: application/json" -d "$PAYLOAD" "${{ secrets.TEAMS_WEBHOOK_URL }}"

      - name: Enviar Reporte por Correo
        uses: dawidd6/action-send-mail@v3
        if: steps.check_report.outputs.report_exists == 'true'
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: Reporte de Pruebas Automatizadas - ${{ github.repository }}
          to: ${{ secrets.MAIL_TO }}
          from: GitHub Actions <${{ secrets.MAIL_USERNAME }}>
          body: |
            Hola,

            La ejecuciÃ³n manual de pruebas ha finalizado.

            Estado del Workflow: ${{ job.status }}
            Repositorio: ${{ github.repository }}
            Ejecutado por: ${{ github.actor }}

            Se adjunta el reporte HTML con los resultados detallados.

            Saludos,
            Tu Bot de AutomatizaciÃ³n
          attachments: target/extent-reports/SparkReport.html
